{% extends 'base.html' %}
{% load static %}

{% block title %}Search Flights - Trip{% endblock %}

{% block content %}
<div class="container py-5">
  <!-- Search Form -->
  <div class="card shadow-lg border-0 mb-5">
    <div class="card-body p-4">
      <h3 class="mb-4">Search Flights</h3>
      <form method="get" id="flightSearchForm">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">From</label>
            <input type="text" class="form-control" name="departure_city" value="{{ search_params.departure_city }}"
              placeholder="Departure city" list="citiesList">
          </div>
          <div class="col-md-3">
            <label class="form-label">To</label>
            <input type="text" class="form-control" name="arrival_city" value="{{ search_params.arrival_city }}"
              placeholder="Arrival city" list="citiesList">
          </div>
          <div class="col-md-3">
            <label class="form-label">Departure Date</label>
            <input type="date" class="form-control" name="departure_date" value="{{ search_params.departure_date }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Passengers</label>
            <select class="form-control" name="passengers">
              <option value="1">1 Passenger</option>
              <option value="2">2 Passengers</option>
              <option value="3">3 Passengers</option>
              <option value="4">4 Passengers</option>
              <option value="5">5+ Passengers</option>
            </select>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary px-4">
              <i class="fas fa-search me-2"></i>Search Flights
            </button>
            <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearForm()">
              <i class="fas fa-times me-2"></i>Clear
            </button>
          </div>
        </div>
      </form>

      <!-- Cities datalist -->
      <datalist id="citiesList">
        {% for city in cities %}
        <option value="{{ city }}">
          {% endfor %}
      </datalist>
    </div>
  </div>

  <!-- Search Results -->
  <div id="searchResults">
    <!-- Results will be populated here via JavaScript -->
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.getElementById('flightSearchForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    // Show loading
    document.getElementById('searchResults').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Searching for flights...</p>
        </div>
    `;

    fetch('{% url "flights:search" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(data => {
        displayFlights(data.flights);
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('searchResults').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                An error occurred while searching for flights. Please try again.
            </div>
        `;
      });
  });

  function displayFlights(flights) {
    const resultsContainer = document.getElementById('searchResults');

    if (flights.length === 0) {
      resultsContainer.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-plane fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No flights found</h4>
                <p class="text-muted">Try adjusting your search criteria</p>
            </div>
        `;
      return;
    }

    let html = '<h4 class="mb-4">Available Flights</h4>';

    flights.forEach(flight => {
      html += `
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="fw-bold mb-2">${flight.flight_number}</h5>
                            <p class="text-muted mb-1">${flight.airline}</p>
                            <div class="d-flex align-items-center">
                                <div class="text-center">
                                    <strong>${flight.departure_airport.split(' - ')[0]}</strong>
                                    <br>
                                    <small class="text-muted">${new Date(flight.departure_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                                </div>
                                <div class="mx-3">
                                    <i class="fas fa-plane text-primary"></i>
                                    <br>
                                    <small class="text-muted">${flight.duration}</small>
                                </div>
                                <div class="text-center">
                                    <strong>${flight.arrival_airport.split(' - ')[0]}</strong>
                                    <br>
                                    <small class="text-muted">${new Date(flight.arrival_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="seat-classes">
                                ${flight.seat_classes.map(seatClass => `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-secondary">${seatClass.type.replace('_', ' ').toUpperCase()}</span>
                                        <strong class="text-primary">$${seatClass.price}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <p class="text-muted small mb-2">${flight.available_seats} seats left</p>
                            <a href="/bookings/create/${flight.id}/" class="btn btn-primary">Book Now</a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    resultsContainer.innerHTML = html;
  }

  function clearForm() {
    document.getElementById('flightSearchForm').reset();
    document.getElementById('searchResults').innerHTML = '';
  }

  // Set minimum date to today
  document.querySelector('input[name="departure_date"]').min = new Date().toISOString().split('T')[0];
</script>
{% endblock %}
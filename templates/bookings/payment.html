{% extends 'base.html' %}
{% load static %}

{% block title %}Payment - {{ booking.booking_reference }} - Trip{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <!-- Payment Form -->
    <div class="col-md-8">
      <!-- Payment Header -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3"
              style="width: 50px; height: 50px;">
              <i class="fas fa-credit-card"></i>
            </div>
            <div>
              <h2 class="h4 mb-0">Complete Payment</h2>
              <p class="text-muted mb-0">Booking Reference: <strong>{{ booking.booking_reference }}</strong></p>
            </div>
          </div>

          <!-- Payment Progress -->
          <div class="row text-center mb-4">
            <div class="col-md-4">
              <div class="d-flex align-items-center justify-content-center">
                <div class="bg-success text-white rounded-circle me-2" style="width: 30px; height: 30px;">
                  <i class="fas fa-check" style="font-size: 14px; margin-top: 7px;"></i>
                </div>
                <span class="text-success">Booking Created</span>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-center justify-content-center">
                <div class="bg-primary text-white rounded-circle me-2" style="width: 30px; height: 30px;">
                  <i class="fas fa-credit-card" style="font-size: 14px; margin-top: 7px;"></i>
                </div>
                <span class="text-primary fw-bold">Payment</span>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-center justify-content-center">
                <div class="bg-secondary text-white rounded-circle me-2" style="width: 30px; height: 30px;">
                  <i class="fas fa-check" style="font-size: 14px; margin-top: 7px;"></i>
                </div>
                <span class="text-muted">Confirmation</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Method Selection -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0">Select Payment Method</h5>
        </div>
        <div class="card-body">
          <form method="POST" id="paymentForm">
            {% csrf_token %}

            <div class="row">
              <!-- Credit Card -->
              <div class="col-md-6 mb-3">
                <label class="payment-method-option">
                  <input type="radio" name="payment_method" value="credit_card" checked>
                  <div class="card h-100 border-2 payment-card">
                    <div class="card-body text-center">
                      <i class="fas fa-credit-card fa-2x text-primary mb-2"></i>
                      <h6>Credit Card</h6>
                      <p class="small text-muted mb-0">Visa, MasterCard, Amex</p>
                    </div>
                  </div>
                </label>
              </div>

              <!-- Debit Card -->
              <div class="col-md-6 mb-3">
                <label class="payment-method-option">
                  <input type="radio" name="payment_method" value="debit_card">
                  <div class="card h-100 border-2 payment-card">
                    <div class="card-body text-center">
                      <i class="fas fa-money-check-alt fa-2x text-success mb-2"></i>
                      <h6>Debit Card</h6>
                      <p class="small text-muted mb-0">Direct bank debit</p>
                    </div>
                  </div>
                </label>
              </div>

              <!-- PayPal -->
              <div class="col-md-6 mb-3">
                <label class="payment-method-option">
                  <input type="radio" name="payment_method" value="paypal">
                  <div class="card h-100 border-2 payment-card">
                    <div class="card-body text-center">
                      <i class="fab fa-paypal fa-2x text-info mb-2"></i>
                      <h6>PayPal</h6>
                      <p class="small text-muted mb-0">Pay with PayPal account</p>
                    </div>
                  </div>
                </label>
              </div>

              <!-- Bank Transfer -->
              <div class="col-md-6 mb-3">
                <label class="payment-method-option">
                  <input type="radio" name="payment_method" value="bank_transfer">
                  <div class="card h-100 border-2 payment-card">
                    <div class="card-body text-center">
                      <i class="fas fa-university fa-2x text-warning mb-2"></i>
                      <h6>Bank Transfer</h6>
                      <p class="small text-muted mb-0">Direct bank transfer</p>
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <!-- Payment Details Form -->
            <div id="paymentDetails" class="mt-4">
              <!-- Credit/Debit Card Details -->
              <div id="cardDetails" class="payment-details active">
                <h6 class="mb-3">Card Information</h6>
                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label class="form-label">Card Number</label>
                    <input type="text" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Expiry Date</label>
                    <input type="text" class="form-control" placeholder="MM/YY" maxlength="5">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">CVV</label>
                    <input type="text" class="form-control" placeholder="123" maxlength="4">
                  </div>
                  <div class="col-md-12 mb-3">
                    <label class="form-label">Cardholder Name</label>
                    <input type="text" class="form-control" placeholder="John Doe">
                  </div>
                </div>
              </div>

              <!-- PayPal Details -->
              <div id="paypalDetails" class="payment-details">
                <div class="text-center py-4">
                  <i class="fab fa-paypal fa-3x text-info mb-3"></i>
                  <p>You will be redirected to PayPal to complete your payment securely.</p>
                </div>
              </div>

              <!-- Bank Transfer Details -->
              <div id="bankDetails" class="payment-details">
                <div class="alert alert-info">
                  <h6 class="alert-heading">Bank Transfer Instructions</h6>
                  <p>Please transfer the amount to the following account:</p>
                  <hr>
                  <p class="mb-1"><strong>Account Name:</strong> Trip Airlines Ltd.</p>
                  <p class="mb-1"><strong>Account Number:</strong> 1234567890</p>
                  <p class="mb-1"><strong>Routing Number:</strong> 021000021</p>
                  <p class="mb-0"><strong>Reference:</strong> {{ booking.booking_reference }}</p>
                </div>
              </div>
            </div>

            <!-- Security Notice -->
            <div class="alert alert-light border mt-4">
              <div class="d-flex align-items-center">
                <i class="fas fa-shield-alt text-success me-2"></i>
                <div>
                  <strong>Secure Payment</strong>
                  <p class="mb-0 small">Your payment information is encrypted and secure. We never store your card
                    details.</p>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid mt-4">
              <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-lock me-2"></i>
                Complete Payment - ${{ booking.total_amount }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Booking Summary Sidebar -->
    <div class="col-md-4">
      <div class="card shadow-sm position-sticky" style="top: 20px;">
        <div class="card-header">
          <h5 class="mb-0">Payment Summary</h5>
        </div>
        <div class="card-body">
          <!-- Flight Info -->
          <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
              <i class="fas fa-plane text-primary me-2"></i>
              <strong>{{ booking.flight.airline.code }}{{ booking.flight.flight_number }}</strong>
            </div>
            <p class="small text-muted mb-1">
              {{ booking.flight.departure_airport.code }} → {{ booking.flight.arrival_airport.code }}
            </p>
            <p class="small text-muted">
              {{ booking.flight.departure_time|date:"M d, Y - H:i" }}
            </p>
          </div>

          <!-- Passengers -->
          <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
              <i class="fas fa-users text-primary me-2"></i>
              <strong>Passengers ({{ booking.passengers.count }})</strong>
            </div>
            {% for passenger in booking.passengers.all %}
            <p class="small mb-1">{{ passenger.first_name }} {{ passenger.last_name }}</p>
            {% endfor %}
          </div>

          <!-- Seat Class -->
          <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
              <i class="fas fa-chair text-primary me-2"></i>
              <strong>{{ booking.seat_class.get_class_type_display }}</strong>
            </div>
          </div>

          <hr>

          <!-- Price Breakdown -->
          <div class="d-flex justify-content-between mb-2">
            <span>Base Fare ({{ booking.passengers.count }} passenger{{ booking.passengers.count|pluralize }})</span>
            <span>${{ booking.flight.base_price }}</span>
          </div>

          {% if booking.seat_class.price_multiplier != 1.0 %}
          <div class="d-flex justify-content-between mb-2">
            <span>{{ booking.seat_class.get_class_type_display }} Upgrade</span>
            <span>×{{ booking.seat_class.price_multiplier }}</span>
          </div>
          {% endif %}

          <div class="d-flex justify-content-between mb-2">
            <span>Taxes & Fees</span>
            <span>$121</span>
          </div>

          <hr>

          <div class="d-flex justify-content-between h5">
            <strong>Total Amount</strong>
            <strong class="text-success">${{ booking.total_amount }}</strong>
          </div>

          <!-- Booking Info -->
          <div class="mt-3 p-3 bg-light rounded">
            <p class="mb-1 small"><strong>Booking Reference:</strong></p>
            <p class="mb-1 fw-bold">{{ booking.booking_reference }}</p>
            <p class="mb-0 small text-muted">Created: {{ booking.created_at|date:"M d, Y" }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .payment-method-option {
    cursor: pointer;
    display: block;
  }

  .payment-method-option input[type="radio"] {
    display: none;
  }

  .payment-card {
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .payment-card:hover {
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  .payment-method-option input[type="radio"]:checked+.payment-card {
    border-color: #007bff !important;
    background-color: #f8f9ff;
  }

  .payment-details {
    display: none;
  }

  .payment-details.active {
    display: block;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Payment method selection
    const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
    const paymentDetails = document.querySelectorAll('.payment-details');

    function showPaymentDetails(method) {
      paymentDetails.forEach(detail => detail.classList.remove('active'));

      switch (method) {
        case 'credit_card':
        case 'debit_card':
          document.getElementById('cardDetails').classList.add('active');
          break;
        case 'paypal':
          document.getElementById('paypalDetails').classList.add('active');
          break;
        case 'bank_transfer':
          document.getElementById('bankDetails').classList.add('active');
          break;
      }
    }

    paymentMethods.forEach(method => {
      method.addEventListener('change', function () {
        showPaymentDetails(this.value);
      });
    });

    // Initialize with first payment method
    showPaymentDetails('credit_card');

    // Card number formatting
    const cardNumberInput = document.querySelector('input[placeholder="1234 5678 9012 3456"]');
    if (cardNumberInput) {
      cardNumberInput.addEventListener('input', function () {
        let value = this.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        this.value = formattedValue;
      });
    }

    // Expiry date formatting
    const expiryInput = document.querySelector('input[placeholder="MM/YY"]');
    if (expiryInput) {
      expiryInput.addEventListener('input', function () {
        let value = this.value.replace(/\D/g, '');
        if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        this.value = value;
      });
    }

    // Form submission
    document.getElementById('paymentForm').addEventListener('submit', function (e) {
      const submitButton = this.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing Payment...';
    });
  });
</script>
{% endblock %}